# ë ˆì´íŒ… ì‹œìŠ¤í…œ ê°€ì´ë“œ

## ê°œìš”

ë°°ë“œë¯¼í„´ ë§¤ì¹­ í”Œë«í¼ì— ê²½ê¸° ì¢…ëª©ë³„ ë ˆì´íŒ… ì‹œìŠ¤í…œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ELO ê¸°ë°˜ ë ˆì´íŒ… ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ í”Œë ˆì´ì–´ì˜ ì‹¤ë ¥ì„ í‰ê°€í•˜ê³ , ì…ì¥ë£Œ ì‹œìŠ¤í…œê³¼ ë³´ìƒ ì‹œìŠ¤í…œì„ í†µí•´ ê²Œì„í™”ëœ ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.

## ì£¼ìš” ê¸°ëŠ¥

### 1. ê²½ê¸° ì¢…ëª©ë³„ ë…ë¦½ ë ˆì´íŒ…

ê° ê²½ê¸° ì¢…ëª©ë§ˆë‹¤ ë…ë¦½ì ì¸ ë ˆì´íŒ…ì´ ê´€ë¦¬ë©ë‹ˆë‹¤:

- **MS (Men's Singles)**: ë‚¨ì ë‹¨ì‹
- **WS (Women's Singles)**: ì—¬ì ë‹¨ì‹
- **MD (Men's Doubles)**: ë‚¨ì ë³µì‹
- **WD (Women's Doubles)**: ì—¬ì ë³µì‹
- **XD (Mixed Doubles)**: í˜¼í•© ë³µì‹

ê° ì‚¬ìš©ìëŠ” ì¢…ëª©ë³„ë¡œ:
- í˜„ì¬ ë ˆì´íŒ… (ê¸°ë³¸ 1500ì )
- ìµœê³  ë ˆì´íŒ…
- ê²½ê¸° ìˆ˜
- ìŠ¹ë¦¬ ìˆ˜
ë¥¼ ê°€ì§‘ë‹ˆë‹¤.

### 2. ì…ì¥ë£Œ ì‹œìŠ¤í…œ

ë§¤ì¹˜ ì„¸ì…˜ ì°¸ê°€ ì‹œ:
- **í¬ì¸íŠ¸** ë˜ëŠ” **ê¹ƒí„¸**ë¡œ ì…ì¥ë£Œ ì§€ë¶ˆ
- ì…ì¥ë£ŒëŠ” ë§¤ì¹˜ ìƒì„± ì‹œ ì„¤ì •
- ì„¸ì…˜ì´ ì·¨ì†Œë˜ë©´ ìë™ í™˜ë¶ˆ

### 3. ìŠ¹ì ë³´ìƒ

ë§¤ì¹˜ ì™„ë£Œ ì‹œ:
- ìŠ¹ì/ìŠ¹ìíŒ€ì€ **í¬ì¸íŠ¸** íšë“
- ë ˆì´íŒ… ì ìˆ˜ ìƒìŠ¹
- ì „ì (ìŠ¹/íŒ¨) ê¸°ë¡

### 4. ë ˆì´íŒ… ê³„ì‚°

#### ë‹¨ì‹ (MS, WS)
- 1:1 ëŒ€ê²°
- ìƒëŒ€ë°©ì˜ ë ˆì´íŒ…ê³¼ ë¹„êµí•˜ì—¬ ê³„ì‚°
- ê°•í•œ ìƒëŒ€ë¥¼ ì´ê¸°ë©´ ë” ë§ì€ ì ìˆ˜ íšë“

#### ë³µì‹ (MD, WD, XD)
- 2:2 íŒ€ ëŒ€ê²°
- íŒ€ì˜ í‰ê·  ë ˆì´íŒ…ìœ¼ë¡œ ê³„ì‚°
- ê° í”Œë ˆì´ì–´ì˜ ë ˆì´íŒ…ì´ ê°œë³„ì ìœ¼ë¡œ ë³€ë™

#### ELO ê³µì‹
```
Expected Score = 1 / (1 + 10^((Opponent Rating - Player Rating) / 400))
Rating Change = K Ã— (Actual Score - Expected Score)
```
- K-factor: 32 (ê¸°ë³¸ê°’)
- Actual Score: ìŠ¹ë¦¬ = 1, íŒ¨ë°° = 0

### 5. ë ˆì´íŒ… í‹°ì–´

| í‹°ì–´ | ë ˆì´íŒ… ë²”ìœ„ | ì•„ì´ì½˜ |
|------|------------|--------|
| Bronze | 0 - 1199 | ğŸ¥‰ |
| Silver | 1200 - 1399 | ğŸ¥ˆ |
| Gold | 1400 - 1599 | ğŸ¥‡ |
| Platinum | 1600 - 1799 | ğŸ’ |
| Diamond | 1800 - 1999 | ğŸ’  |
| Master | 2000 - 2199 | ğŸ‘‘ |
| Grandmaster | 2200+ | ğŸ† |

## ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

### ì£¼ìš” í…Œì´ë¸”

#### `match_sessions`
ë§¤ì¹˜ ì„¸ì…˜ ì •ë³´
- ê²½ê¸° ì¢…ëª© (match_type)
- ì…ì¥ë£Œ ì„¤ì • (entry_fee_points, entry_fee_feathers)
- ìŠ¹ì ë³´ìƒ (winner_points)
- ë§¤ì¹˜ ê²°ê³¼ (result, team1_score, team2_score)
- ìƒíƒœ (status: PENDING, IN_PROGRESS, COMPLETED, CANCELLED)

#### `match_participants`
ë§¤ì¹˜ ì°¸ê°€ì ì •ë³´
- íŒ€ ë°°ì • (team: 1 or 2)
- ì…ì¥ë£Œ ì§€ë¶ˆ ë‚´ì—­
- ë ˆì´íŒ… ë³€ë™ (rating_before, rating_after, rating_change)
- í¬ì¸íŠ¸ íšë“ (points_earned)

#### `rating_history`
ë ˆì´íŒ… ë³€ë™ ì´ë ¥
- ê²½ê¸° ì¢…ëª©ë³„ ë ˆì´íŒ… ë³€í™” ì¶”ì 
- ìŠ¹/íŒ¨ ê¸°ë¡

#### `match_entry_transactions`
ì…ì¥ë£Œ ê±°ë˜ ë‚´ì—­
- ì…ì¥ë£Œ ì°¨ê°
- í™˜ë¶ˆ ë‚´ì—­

### ì‚¬ìš©ì í…Œì´ë¸” í™•ì¥

`users` í…Œì´ë¸”ì— ì¶”ê°€ëœ í•„ë“œ:
```sql
-- ë ˆì´íŒ…
rating_ms, rating_ws, rating_md, rating_wd, rating_xd INTEGER DEFAULT 1500

-- ìµœê³  ë ˆì´íŒ…
peak_rating_ms, peak_rating_ws, peak_rating_md, peak_rating_wd, peak_rating_xd INTEGER DEFAULT 1500

-- ê²½ê¸° ìˆ˜
games_ms, games_ws, games_md, games_wd, games_xd INTEGER DEFAULT 0

-- ìŠ¹ë¦¬ ìˆ˜
wins_ms, wins_ws, wins_md, wins_wd, wins_xd INTEGER DEFAULT 0
```

## API ì—”ë“œí¬ì¸íŠ¸

### ë§¤ì¹˜ ì„¸ì…˜ ê´€ë¦¬

#### `POST /api/matches/sessions`
ìƒˆ ë§¤ì¹˜ ì„¸ì…˜ ìƒì„±
```json
{
  "matchType": "MS" | "WS" | "MD" | "WD" | "XD",
  "entryFeePoints": 100,
  "entryFeeFeathers": 0,
  "winnerPoints": 100,
  "location": "ì„œìš¸ ì²´ìœ¡ê´€",
  "courtNumber": 1,
  "participants": [
    { "userId": "user1", "team": 1 },
    { "userId": "user2", "team": 2 }
  ]
}
```

#### `GET /api/matches/sessions`
ë§¤ì¹˜ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ
- Query params: `matchType`, `status`, `userId`, `meetingId`, `limit`, `offset`

#### `POST /api/matches/sessions/[sessionId]/join`
ë§¤ì¹˜ ì„¸ì…˜ ì°¸ê°€ ë° ì…ì¥ë£Œ ì§€ë¶ˆ
```json
{
  "paymentMethod": "points" | "feathers"
}
```

#### `POST /api/matches/sessions/[sessionId]/complete`
ë§¤ì¹˜ ì™„ë£Œ ë° ê²°ê³¼ ê¸°ë¡
```json
{
  "result": "PLAYER1_WIN" | "PLAYER2_WIN" | "TEAM1_WIN" | "TEAM2_WIN",
  "team1Score": 21,
  "team2Score": 15
}
```

#### `POST /api/matches/sessions/[sessionId]/cancel`
ë§¤ì¹˜ ì·¨ì†Œ ë° ì…ì¥ë£Œ í™˜ë¶ˆ

### ë¦¬ë”ë³´ë“œ

#### `GET /api/leaderboard/[matchType]`
ê²½ê¸° ì¢…ëª©ë³„ ë¦¬ë”ë³´ë“œ ì¡°íšŒ
- Path param: `MS` | `WS` | `MD` | `WD` | `XD` | `ALL`
- Query params: `region`, `limit`, `offset`

Response:
```json
{
  "matchType": "MS",
  "region": "all",
  "total": 100,
  "limit": 50,
  "offset": 0,
  "leaderboard": [
    {
      "rank": 1,
      "userId": "...",
      "name": "í™ê¸¸ë™",
      "nickname": "ë°°ë“œí‚¹",
      "rating": 1850,
      "peakRating": 1900,
      "gamesPlayed": 50,
      "wins": 35,
      "losses": 15,
      "winRate": 70.0
    }
  ]
}
```

### ì‚¬ìš©ì ë ˆì´íŒ… ì •ë³´

#### `GET /api/users/[userId]/ratings`
ì‚¬ìš©ìì˜ ë ˆì´íŒ… í†µê³„ ì¡°íšŒ

Response:
```json
{
  "user": { ... },
  "overall": {
    "highestRating": 1850,
    "totalGames": 120,
    "totalWins": 75,
    "winRate": 62.5
  },
  "byMatchType": [
    {
      "matchType": "MS",
      "rating": 1850,
      "peakRating": 1900,
      "gamesPlayed": 50,
      "wins": 35,
      "winRate": 70.0
    }
  ],
  "recentHistory": [ ... ]
}
```

## UI í˜ì´ì§€

### `/ratings`
ë ˆì´íŒ… ë¦¬ë”ë³´ë“œ í˜ì´ì§€
- ê²½ê¸° ì¢…ëª©ë³„ í•„í„°ë§
- ì§€ì—­ë³„ í•„í„°ë§
- ë­í‚¹, í‹°ì–´, ì „ì  í‘œì‹œ

### `/matches/create`
ë§¤ì¹˜ ì„¸ì…˜ ìƒì„± í˜ì´ì§€
- ê²½ê¸° ì¢…ëª© ì„ íƒ
- ì…ì¥ë£Œ ì„¤ì • (í¬ì¸íŠ¸/ê¹ƒí„¸)
- ìŠ¹ì ë³´ìƒ í¬ì¸íŠ¸ ì„¤ì •
- í”Œë ˆì´ì–´ ê²€ìƒ‰ ë° íŒ€ ë°°ì •

### `/profile/[userId]` (ê¸°ì¡´ í˜ì´ì§€ í™•ì¥)
ì‚¬ìš©ì í”„ë¡œí•„ì— ë ˆì´íŒ… ì •ë³´ í‘œì‹œ
- ì¢…ëª©ë³„ ë ˆì´íŒ… ë° ì „ì 
- ë ˆì´íŒ… ë³€ë™ ê·¸ë˜í”„
- ìµœê·¼ ë§¤ì¹˜ ê¸°ë¡

## ë°ì´í„°ë² ì´ìŠ¤ í•¨ìˆ˜

### `calculate_rating_change()`
ë ˆì´íŒ… ë³€ë™ ê³„ì‚°
```sql
SELECT calculate_rating_change(1500, 1600, true, 32);
-- Returns: +23 (assuming player with 1500 rating beats 1600 rating opponent)
```

### `get_team_avg_rating()`
íŒ€ í‰ê·  ë ˆì´íŒ… ê³„ì‚° (ë³µì‹ìš©)

### `complete_match_session()`
ë§¤ì¹˜ ì™„ë£Œ ì²˜ë¦¬
- ë ˆì´íŒ… ì—…ë°ì´íŠ¸
- í¬ì¸íŠ¸ ì§€ê¸‰
- ì „ì  ê¸°ë¡
- íˆìŠ¤í† ë¦¬ ìƒì„±

### `refund_match_entry_fees()`
ì…ì¥ë£Œ í™˜ë¶ˆ ì²˜ë¦¬
- í¬ì¸íŠ¸/ê¹ƒí„¸ í™˜ë¶ˆ
- ê±°ë˜ ê¸°ë¡
- ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸

## ì‚¬ìš© íë¦„

### ë§¤ì¹˜ ìƒì„± ë° ì§„í–‰

1. **ë§¤ì¹˜ ìƒì„±**
   ```
   í˜¸ìŠ¤íŠ¸ê°€ /matches/create ì—ì„œ ë§¤ì¹˜ ì„¸ì…˜ ìƒì„±
   â†’ ê²½ê¸° ì¢…ëª©, ì…ì¥ë£Œ, ë³´ìƒ ì„¤ì •
   â†’ í”Œë ˆì´ì–´ ì„ íƒ ë° íŒ€ ë°°ì •
   ```

2. **ì°¸ê°€ ë° ì…ì¥ë£Œ ì§€ë¶ˆ**
   ```
   ê° ì°¸ê°€ìê°€ ì…ì¥ë£Œ ì§€ë¶ˆ
   â†’ POST /api/matches/sessions/[sessionId]/join
   â†’ í¬ì¸íŠ¸ ë˜ëŠ” ê¹ƒí„¸ ì°¨ê°
   ```

3. **ê²½ê¸° ì§„í–‰**
   ```
   ë§¤ì¹˜ ìƒíƒœ: PENDING â†’ IN_PROGRESS
   â†’ ì‹¤ì œ ê²½ê¸° ì§„í–‰
   ```

4. **ê²°ê³¼ ê¸°ë¡**
   ```
   ê²°ê³¼ ì…ë ¥
   â†’ POST /api/matches/sessions/[sessionId]/complete
   â†’ ë ˆì´íŒ… ê³„ì‚° ë° ì—…ë°ì´íŠ¸
   â†’ í¬ì¸íŠ¸ ë³´ìƒ ì§€ê¸‰
   ```

5. **ì™„ë£Œ**
   ```
   ë§¤ì¹˜ ìƒíƒœ: COMPLETED
   â†’ ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
   â†’ ë ˆì´íŒ… íˆìŠ¤í† ë¦¬ ê¸°ë¡
   ```

### ì·¨ì†Œ íë¦„

```
ë§¤ì¹˜ ì·¨ì†Œ
â†’ POST /api/matches/sessions/[sessionId]/cancel
â†’ ì…ì¥ë£Œ ìë™ í™˜ë¶ˆ
â†’ ë§¤ì¹˜ ìƒíƒœ: CANCELLED
```

## íƒ€ì… ì •ì˜

TypeScript íƒ€ì…ì€ `/types/rating.ts`ì— ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤:
- `MatchType`
- `MatchSession`
- `MatchParticipant`
- `RatingHistory`
- `LeaderboardEntry`
- `UserRatingProfile`
- etc.

## í…ŒìŠ¤íŠ¸

### ë§¤ì¹˜ ì„¸ì…˜ ìƒì„± í…ŒìŠ¤íŠ¸
```bash
curl -X POST http://localhost:3000/api/matches/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "matchType": "MS",
    "entryFeePoints": 100,
    "winnerPoints": 150,
    "participants": [
      {"userId": "user1_id", "team": 1},
      {"userId": "user2_id", "team": 2}
    ]
  }'
```

### ë¦¬ë”ë³´ë“œ ì¡°íšŒ í…ŒìŠ¤íŠ¸
```bash
curl http://localhost:3000/api/leaderboard/MS?limit=10
```

## í–¥í›„ ê°œì„  ì‚¬í•­

1. **ì‹œì¦Œ ì‹œìŠ¤í…œ**
   - ì‹œì¦Œë³„ ë ˆì´íŒ… ë¦¬ì…‹
   - ì‹œì¦Œ ë¦¬ì›Œë“œ

2. **ë§¤ì¹˜ë©”ì´í‚¹**
   - ë ˆì´íŒ… ê¸°ë°˜ ìë™ ë§¤ì¹­
   - ë°¸ëŸ°ìŠ¤ íŒ€ êµ¬ì„±

3. **í† ë„ˆë¨¼íŠ¸ ëª¨ë“œ**
   - í† ë„ˆë¨¼íŠ¸ ìƒì„± ë° ê´€ë¦¬
   - ë¸Œë¼ì¼“ ì‹œìŠ¤í…œ

4. **ë ˆì´íŒ… ë³´í˜¸**
   - ì‹ ê·œ ìœ ì € ë ˆì´íŒ… ë³´í˜¸ ê¸°ê°„
   - ì—°ì† íŒ¨ë°° ë³´í˜¸

5. **í†µê³„ ëŒ€ì‹œë³´ë“œ**
   - ìƒì„¸ í†µê³„ í˜ì´ì§€
   - ë ˆì´íŒ… ë³€ë™ ê·¸ë˜í”„
   - ìµœê·¼ ê²½ê¸° ë¶„ì„

## ë¬¸ì˜

ì‹œìŠ¤í…œ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ë‚˜ ë²„ê·¸ ë¦¬í¬íŠ¸ëŠ” ì´ìŠˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.
